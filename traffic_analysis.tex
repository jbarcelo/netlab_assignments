\chapter{Traffic Analysis}

\section{Introduction}

The goal of this lab assignment is to know and use monitoring and traffic analysis tools. We shall use the \emph{Wireshark} and \emph{tcpdump} software tools to study different layers of the TCP/IP architecture.

\section{Home Preparation}

Review the TCP/IP model and explain the function of each layer. Provide examples of the protocols at each layer of the protocol stack.

\emph{What is the purpose of ARP?}

Draw a sketch of the different messages being exchanged and the different steps involved.

\emph{Is it possible to run this protocol between computers that are in different local area networks (LANs)? What is the ICMP protocol?}

How does the \emph{ping} command work?
What does the \emph{ping} command measure?
Explain and draw an SSL connection indicating how the protocol works and which messages are being exchanged.

\section{Disable your local firewall}

On a Linux machine, your local firewall can interfere with the assignment.
Disable it using the command \texttt{service iptables stop} with root permissions.

\section{WireShark Network Analyzer}

Start your computer in Linux. Start the WireShark software program and choose the correct network interface from the \emph{Capture} $>$ \emph{Interfaces} dialog. Use it to start the packet capture. It is also possible to configure the length of the capture and other details.

\emph{What interface does WireShark detect? What is your IP address? What is the corresponding MAC address?}

Configure the \emph{Capture} $>$ \emph{Interfaces} options to perform a five minutes capture. Observe the results and answer the following questions.

\emph{What is the total number of captured packets? Are there lost packets? If yes, why?}

Select a (any) packet. Observe the details and answer the following questions.

\emph{What is the source and destination IP address? What are the source and destination MAC addresses? What is the number of bytes in the packet? What protocols can you see in the packet? Is there HTTP? If yes, what is the length of the HTTP message (the payload of the TCP segment or segments)? What are the source and destination port?}

In the dialog \emph{Analyze} $>$ \emph{Enable Protocols...}, it is possible to configure the protocols that WireShark will capture and display. Looking at the default protocols, find at least one protocol of each of the four upper layers of the TCP/IP stack (Application/Transport/Internet/Link). Include a brief description of the protocols you found.

Go to the menu \emph{Statistics} $>$ \emph{Protocol Hierarchy} and observe the percentage of the following protocols: Ethernet, Internet Protocol, TCP, UDP, Logical Link Control, ARP, STP, IPv6, HTTP.

\textbf{Include IPv6 practice with a ping to the local-link IPv6 address of a neighbor. Use: \texttt{ping6 -I iface addr} or a failed ping to \texttt{ping6 ipv6.google.com}.}

\emph{What are the differences between IPv4 and IPv6?}

\section{The ARP Protocol}

The Address Resolution Protocol (ARP) resolves the association between an IP address and a MAC address. It is used in IP over Ethernet networks. Capture traffic and analyze the ARP packets. You can filter the ARP packets writing "ARP" in the \emph{Filter Toolbar}.

\emph{What are the source and destination MAC addresses of the Ethernet frame that contains the ARP request message? Can you see the source and destination IP addresses in the ARP request frame?}

\textbf{Clear the ARP cache \texttt{sudo ip neighbour flush all}.}

Look for an ARP request-reply exchange and write the source and destination MAC and IP addresses.

\emph{What is the time elapsing between an ARP request and reply messages?}

Use the information available in WireShark to indicate the length of the ARP frames and draw the format of the messages.

\emph{To which layer does ARP belong?}

\section{HTTP and Secure HTTP}

Make a new 5 minutes capture and during this time visit a few web sites. After the capture is finished observe the different HTTP and HTTPS messages.
Use the filter toolbar to filter the messages. Observe an HTTP GET message and the corresponding response and answer the following questions.

\textbf{The filter for HTTP or HTTPS should be \texttt{http or ssl}.}

\emph{What is the HTTP version of your web browser? And the HTTP version of the server? What language does the client request to the server? Is it possible to find which are the URLs visited by the user? At which layer is this information available?}

The default destination port for web is 80 or 8080 when using a web proxy.

\emph{What is the source port of the get requests? Write the source port number for different connections. At which layer can you find this information?}

Find a DNS query/response pair.

\emph{What is the function of DNS?}

Use the option \emph{Analyze} $>$ \emph{Follow TCP Stream} to analyze a TCP session. Identify the three-way-handshake and the session tear-down.

\emph{If HTTP is used, it is possible to observe the contents of the web using WireShark?}

Now use HTTPS.

\emph{Is it still possible to read the information that is being transmitted?} Hint: look for SSL packets.

Identify a SSL handshake in WireShark.

\section{ICMP Ping Packet Capture (Homework)}

Close all the applications that use the network and ping four different web sites in four different continents. Analyze the results.

\emph{What protocols are used?}

Draw a frame and explain how the different packet are encapsulated in each other.

\emph{How many ping messages are transmitted by default?}

Prepare a table with the source, destination, and average packet delay  of the four different ping experiments.

\emph{What is the packet length? At which layers can we find source and destination addresses? Which kind of addresses? Are the ping packets sent uniformly in time? What about the answers? What are the reasons for different inter-arrival times for the answers? What information is included in the data field of the ICMP packets? What about in the reply messages?}

\section{tcpdump}

In this section we will use the \texttt{tcpdump} command in Linux. Use \texttt{man tcpdump} to learn about the different parameters and options of this command. With \texttt{tcpdump} it is also possible to filter the traffic according to the source or destination addresses, protocol, port number, etc.

Open a terminal and launch a \texttt{tcpdump} capture. Finish the capture using "Ctrl-C". What is the information provided by tcpdump and which format is being used? To which level does the information belong? Hint: remember that you can redirect the output using the command \texttt{\$ tcmpdump $>$ my-file}.

The first line of \texttt{tcpdump} specifies which interface is being used and it can be changed using the \texttt{-i} option. What interface are you using?

Describe the information provided for the ARP protocol (\texttt{tcpdump arp}).

Execute the same command again using the \texttt{-e} option. What is the difference with respect to the previous execution? Check the \texttt{tcpdump} manual if necessary.

Try several new captures related to this assignment, such as \texttt{tcpdump stp}, \texttt{tcpdump http}, \texttt{tcpdump http}, \texttt{tcpdump udp}, \texttt{tcpdump ssl}, \texttt{tcpdump ip}, etc. Try also to make captures for a specific IP address.
